# .circleci/config.yml
version: 2.1

orbs:
  slack: circleci/slack@1.0.0
  
jobs:
  build:
    working_directory: ~/Beauty.jl

    docker:
      - image: quantumfactory/buildbot-julia:version1.0.test

    steps:
      - checkout
      
      - restore_cache:
          key: julia

      - run:
          name: Test Package in Julia
          command: julia --project=. -e "import Pkg; Pkg.test()"
          
      - run:
          name: Build Documentation
          command: julia --project=. docs/make.jl          

      - save_cache:
          key: julia
          paths:
            - "~/.julia"
        
      - store_artifacts:
          path: docs/build
          destination: docs

      - add_ssh_keys:
          fingerprints:
            - "94:6c:f0:23:54:54:1a:43:98:82:1b:52:a5:5a:7a:ea"

      - run:
          name: Upload Documentation
          command: |
            echo "|1|dhkE9c7oL8H3OVgPs0HgWh6i2Hw=|0ZHcUZDlDmMyWdN4qt3oPoxksZg= ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAILFrePFd+1xbvJivY6MdInlhY3x1F3DiazzTswAyHjvt" >> ~/.ssh/known_hosts
            mv docs/build docs/Beauty.jl && echo -e 'put -r docs/Beauty.jl' | sftp -P $SSH_PORT $SSH_USER@$SSH_HOST:docs/github.com/Quantum-Factory

      - slack/status:
          fail_only: "false"

workflows:
  version: 2
  my-workflow:
    jobs:
      - build:
          context: default
